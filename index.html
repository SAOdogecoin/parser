<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&amp;family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-primary: #1a73e8;
            --theme-secondary: #1a73e8;
            --theme-darker: #0051C3;
            --theme-surface: #f0f4fc;
            --theme-surface-variant: #e8f0fe;
            --bg-primary: #ffffff;
            --bg-secondary: color-mix(in srgb, var(--theme-primary) 5%, #ffffff);
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        :root.dark {
            --bg-primary: rgb(23, 33, 43); /* New dark mode background color */
            --bg-secondary: rgb(23, 33, 43);
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --theme-surface: color-mix(in srgb, var(--theme-primary) 8%, var(--bg-secondary));
            --theme-surface-variant: color-mix(in srgb, var(--theme-darker) 12%, var(--bg-secondary));
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Google Sans', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: calc(100% - 30px);
            max-width: 890px;
            min-width: 320px;
            padding: 20px;
            height: calc(100vh - 100px);
            background-color: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 15px auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container.with-background {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        :root.dark .container.with-background {
            background: rgba(41, 42, 45, 0.8);
        }

        body.with-background {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        h1 {
            margin-left: 0px;
            color: var(--theme-primary);
            font-size: 26px;
            line-height: 40px;
            font-weight: 500;
            background: linear-gradient(to right, var(--theme-primary), var(--theme-darker));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        :root.dark h1 {
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
            -webkit-text-fill-color: white;
            color: white;
        }

        button {
            background-color: var(--theme-primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-family: 'Google Sans', Arial, sans-serif;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: var(--theme-darker);
            transform: translateY(-1px);
            box-shadow: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        button:disabled {
            background-color: rgba(0, 0, 0, 0.12);
            color: rgba(0, 0, 0, 0.38);
            cursor: not-allowed;
            pointer-events: none;
        }

        .dark button:disabled {
            background-color: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.38);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web App</h1>
        <textarea id="shipmentInput" rows="10" cols="50"></textarea>
        <button onclick="parseShipmentData()">Parse</button>
        <button onclick="clearData()">Clear</button>
        <div id="output"></div>
        <button id="copyButton" onclick="copyOutput()">Copy</button>
        <button onclick="toggleTemplateToAll()">Template All</button>
        <button onclick="toggleTemplateEveryTwo()">Template Every Two</button>
        <div id="templateCount">0</div>
    </div>
    <script>
        let editPopup = null;
        let currentEditItem = null;
        let currentTheme = 'light';
        let currentTemplateMode = null;
        let originalParsedContent = '';
        let templateCounter = 0;
        let trackingKeywords = JSON.parse(localStorage.getItem('trackingKeywords')) || ['(AMZL)', '(AMZN)'];
        let templates = JSON.parse(localStorage.getItem('templates')) || [{
            text: "We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were delivered, could you please provide the proof of delivery?",
            active: true
        }];
        let autoParse = localStorage.getItem('autoParse') === 'true' || false;
        let autoTemplate = localStorage.getItem('autoTemplate') === 'true' || false;
        let autoTemplateCopy = localStorage.getItem('autoTemplateCopy') === 'true' || false;
        let customTemplateInterval = 2;
        let autoTracking = localStorage.getItem('autoTracking') === 'true' || false;

        function setThemeColor(color) {
            let primaryColor = color;
            let secondaryColor = color;
            const darkerColor = adjustColor(primaryColor, -20);
            const lighterColor = adjustColor(primaryColor, 10);
            document.documentElement.style.setProperty('--theme-primary', primaryColor);
            document.documentElement.style.setProperty('--theme-secondary', secondaryColor);
            document.documentElement.style.setProperty('--theme-darker', darkerColor);
            document.documentElement.style.setProperty('--theme-surface', `color-mix(in srgb, ${primaryColor} 8%, var(--bg-secondary))`);
            document.documentElement.style.setProperty('--theme-surface-variant', `color-mix(in srgb, ${darkerColor} 12%, var(--bg-secondary))`);
            if (!document.documentElement.classList.contains('dark')) {
                document.body.style.backgroundColor = `color-mix(in srgb, ${primaryColor} 5%, var(--bg-secondary))`;
            }
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.classList.toggle('active', option.dataset.color === color);
            });
        }

        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function parseShipmentData() {
            const input = document.getElementById('shipmentInput').value;
            const outputContainer = document.getElementById('output');
            const copyButton = document.getElementById('copyButton');
            const clearButton = document.querySelector('button[onclick="clearData()"]');
            const templateButton1 = document.querySelector('button[onclick="toggleTemplateToAll()"]');
            const templateButton2 = document.querySelector('button[onclick="toggleTemplateEveryTwo()"]');
            clearButton.disabled = !input.trim();
            outputContainer.innerHTML = '';
            copyButton.style.display = 'block';
            currentTemplateMode = null;
            originalParsedContent = '';
            templateCounter = 0;
            document.getElementById('templateCount').textContent = '0';
            copyButton.disabled = true;
            clearButton.disabled = true;
            templateButton1.disabled = true;
            templateButton2.disabled = true;
            let removalOrderId = '';
            const removalOrderMatch = input.match(/Removal order ID:\s*([^\n]+)/);
            if (removalOrderMatch) {
                removalOrderId = removalOrderMatch[1].trim();
            }
            const shipmentSections = input.split(/Shipment ID:/g).filter(section => section.trim() !== '');
            const allOutputs = [];
            shipmentSections.forEach(section => {
                let trackingMatches = [];
                trackingKeywords.forEach(keyword => {
                    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const matches = section.match(new RegExp(`[A-Z0-9]+${escapedKeyword}`, 'g')) || [];
                    trackingMatches = trackingMatches.concat(matches);
                });
                if (!trackingMatches || trackingMatches.length === 0) return;
                const trackingNumbers = trackingMatches.join(', ');
                const productLines = section.split('\n').filter(line => line.includes('Merchant SKU') || line.includes('FNSKU:') || line.includes('EAN:') || line.includes('UPC:') || line.includes('Condition:'));
                const parsedProducts = [];
                let currentProduct = {};
                let lastKeywordSeen = null;
                for (let i = 0; i < productLines.length; i++) {
                    const line = productLines[i].trim();
                    if (line.startsWith('Merchant SKU:')) {
                        if (currentProduct.merchantSku) {
                            parsedProducts.push(currentProduct);
                        }
                        currentProduct = {
                            merchantSku: line.split('Merchant SKU:')[1].trim()
                        };
                        lastKeywordSeen = null;
                    }
                    if (line.startsWith('FNSKU:')) {
                        currentProduct.fnsku = line.split('FNSKU:')[1].trim();
                    }
                    if (line.startsWith('EAN:') || line.startsWith('UPC:') || line.startsWith('Condition:')) {
                        lastKeywordSeen = line;
                    }
                    if (line.match(/^\d{1,4}$/) && lastKeywordSeen) {
                        currentProduct.qty = parseInt(line);
                        parsedProducts.push(currentProduct);
                        currentProduct = {};
                        lastKeywordSeen = null;
                    }
                }
                const outputParts = [`Removal order ID:${removalOrderId}`, `Shipment ID:${section.split('\n')[0].trim()}`, `Tracking Number(s):${trackingNumbers}`];
                const productOutputs = [];
                parsedProducts.forEach((p, index) => {
                    const productOutput = [`Merchant SKU:${p.merchantSku}`, `FNSKU:${p.fnsku}`, `Qty:${p.qty}`];
                    productOutputs.push(productOutput.join('\n'));
                    if (index < parsedProducts.length - 1) {
                        productOutputs.push('');
                    }
                });
                const outputText = outputParts.concat(productOutputs).join('\n');
                allOutputs.push(outputText);
            });
            if (allOutputs.length > 0) {
                const finalOutput = allOutputs.join('\n\n');
                outputContainer.textContent = finalOutput;
                originalParsedContent = finalOutput;
                clearButton.disabled = false;
                templateButton1.disabled = false;
                templateButton2.disabled = false;
                copyButton.disabled = templateCounter === 0;
            } else {
                outputContainer.textContent = 'No shipments with (AMZL) tracking numbers found.';
                copyButton.disabled = true;
                clearButton.disabled = true;
                templateButton1.disabled = true;
                templateButton2.disabled = true;
            }
            copyButton.textContent = 'Copy';
        }

        function clearData() {
            document.getElementById('shipmentInput').value = '';
            const outputContainer = document.getElementById('output');
            outputContainer.textContent = '';
            currentTemplateMode = null;
            originalParsedContent = '';
            templateCounter = 0;
            document.getElementById('templateCount').textContent = '0';
            const copyButton = document.getElementById('copyButton');
            const clearButton = document.querySelector('button[onclick="clearData()"]');
            const templateButton1 = document.querySelector('button[onclick="toggleTemplateToAll()"]');
            const templateButton2 = document.querySelector('button[onclick="toggleTemplateEveryTwo()"]');
            copyButton.disabled = true;
            clearButton.disabled = true;
            templateButton1.disabled = true;
            templateButton2.disabled = true;
        }

        function copyOutput() {
            const outputContainer = document.getElementById('output');
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = outputContainer.textContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            const copyButton = document.getElementById('copyButton');
            copyButton.classList.add('clicked');
            copyButton.classList.add('copied');
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.classList.remove('clicked');
            }, 600);
            setTimeout(() => {
                copyButton.classList.remove('copied');
                copyButton.textContent = 'Copy';
            }, 2000);
        }

        function toggleTemplateToAll() {
            const outputContainer = document.getElementById('output');
            const templateCountDisplay = document.getElementById('templateCount');
            const copyButton = document.getElementById('copyButton');
            const activeTemplates = templates.filter(t => t.active);
            if (!activeTemplates.length) {
                alert('Please add at least one active template in settings');
                return;
            }
            const template = activeTemplates[0].text + '\n\n';
            if (!originalParsedContent) {
                originalParsedContent = outputContainer.textContent;
            }
            if (currentTemplateMode === 'all') {
                outputContainer.textContent = originalParsedContent;
                currentTemplateMode = null;
                templateCountDisplay.textContent = '0';
                templateCounter = 0;
                copyButton.disabled = true;
                return;
            }
            const sections = originalParsedContent.split(/(?=Removal order ID:)/g);
            templateCounter = 0;
            const modifiedContent = sections.map(section => {
                if (section.trim().startsWith('Removal order ID:')) {
                    templateCounter++;
                    return template + section;
                }
                return section;
            }).join('');
            outputContainer.textContent = modifiedContent;
            currentTemplateMode = 'all';
            templateCountDisplay.textContent = templateCounter;
            copyButton.disabled = templateCounter === 0;
            if (autoTemplateCopy && templateCounter > 0) {
                copyOutput();
            }
        }

        function toggleTemplateEveryTwo() {
            const outputContainer = document.getElementById('output');
            const templateCountDisplay = document.getElementById('templateCount');
            const copyButton = document.getElementById('copyButton');
            const templateButton = document.querySelector('button[onclick="toggleTemplateEveryTwo()"]');
            const activeTemplates = templates.filter(t => t.active);
            if (!activeTemplates.length) {
                alert('Please add at least one active template in settings');
                return;
            }
            const template = activeTemplates[0].text + '\n\n';
            if (!originalParsedContent) {
                originalParsedContent = outputContainer.textContent;
            }
            if (currentTemplateMode === 'custom') {
                outputContainer.textContent = originalParsedContent;
                currentTemplateMode = null;
                templateCountDisplay.textContent = '0';
                templateCounter = 0;
                copyButton.disabled = true;
                return;
            }
            const sections = originalParsedContent.split(/(?=Removal order ID:)/g);
            templateCounter = 0;
            const modifiedSections = sections.map((section, index) => {
                if (section.trim().startsWith('Removal order ID:') && index % customTemplateInterval === 0) {
                    templateCounter++;
                    return template + section;
                }
                return section;
            });
            outputContainer.textContent = modifiedSections.join('');
            currentTemplateMode = 'custom';
            templateCountDisplay.textContent = templateCounter;
            copyButton.disabled = templateCounter === 0;
            if (autoTemplateCopy && templateCounter > 0) {
                copyOutput();
            }
        }
      
function parseTrackingOnly() {
    const input = document.getElementById('shipmentInput').value;
    const outputContainer = document.getElementById('output');
    const copyButton = document.getElementById('copyButton');
    const clearButton = document.querySelector('button[onclick="clearData()"]');
    clearButton.disabled = !input.trim();
    outputContainer.innerHTML = '';
    copyButton.style.display = 'block';
    currentTemplateMode = null;
    originalParsedContent = '';
    templateCounter = 0;
    document.getElementById('templateCount').textContent = '0';
    copyButton.disabled = true;
    clearButton.disabled = true;
    const trackingNumbers = [];
    const sections = input.split(/Shipment ID:/g);
    sections.forEach(section => {
        trackingKeywords.forEach(keyword => {
            const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const matches = section.match(new RegExp(`([A-Z0-9]+)${escapedKeyword}`, 'g')) || [];
            matches.forEach(match => {
                const trackingNumber = match.replace(new RegExp(escapedKeyword + '$'), '');
                if (!trackingNumbers.includes(trackingNumber)) {
                    trackingNumbers.push(trackingNumber);
                }
            });
        });
    });
    if (trackingNumbers.length > 0) {
        const finalOutput = trackingNumbers.join('\n');
        outputContainer.textContent = finalOutput;
        originalParsedContent = finalOutput;
        clearButton.disabled = false;
        copyButton.disabled = false;
    } else {
        outputContainer.textContent = 'No tracking numbers found.';
        copyButton.disabled = true;
        clearButton.disabled = true;
    }
    copyButton.textContent = 'Copy';
}

function toggleAutoParse() {
    const button = document.getElementById('autoParseToggle');
    const autoTrackingButton = document.getElementById('autoTrackingToggle');
    autoParse = !autoParse;
    localStorage.setItem('autoParse', autoParse);
    button.textContent = `Auto-Parse: ${autoParse ? 'On' : 'Off'}`;
    button.style.backgroundColor = autoParse ? getComputedStyle(document.documentElement).getPropertyValue('--theme-darker') : getComputedStyle(document.documentElement).getPropertyValue('--theme-primary');
    autoTrackingButton.disabled = !autoParse;
    if (!autoParse && autoTracking) {
        toggleAutoTracking();
    }
}

function toggleAutoTemplate() {
    const button = document.getElementById('autoTemplateToggle');
    autoTemplate = !autoTemplate;
    localStorage.setItem('autoTemplate', autoTemplate);
    button.textContent = `Auto-Template: ${autoTemplate ? 'On' : 'Off'}`;
    button.style.backgroundColor = autoTemplate ? getComputedStyle(document.documentElement).getPropertyValue('--theme-darker') : getComputedStyle(document.documentElement).getPropertyValue('--theme-primary');
}

function toggleAutoTemplateCopy() {
    const button = document.getElementById('autoTemplateCopyToggle');
    autoTemplateCopy = !autoTemplateCopy;
    localStorage.setItem('autoTemplateCopy', autoTemplateCopy);
    button.textContent = `Auto-Copy: ${autoTemplateCopy ? 'On' : 'Off'}`;
    button.style.backgroundColor = autoTemplateCopy ? getComputedStyle(document.documentElement).getPropertyValue('--theme-darker') : getComputedStyle(document.documentElement).getPropertyValue('--theme-primary');
}

function getProminentColor(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = 25;
    canvas.width = size;
    canvas.height = size;
    ctx.drawImage(img, 0, 0, size, size);
    const data = ctx.getImageData(0, 0, size, size).data;
    let r = 0, g = 0, b = 0;
    for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
    }
    const pixelCount = data.length / 4;
    r = Math.floor(r / pixelCount);
    g = Math.floor(g / pixelCount);
    b = Math.floor(b / pixelCount);
    const hex = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    return hex;
}

function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
                const prominentColor = getProminentColor(img);
                setThemeColor(prominentColor);
                document.body.style.backgroundImage = `url(${e.target.result})`;
                document.body.classList.add('with-background');
                document.querySelector('.container').classList.add('with-background');
                const removeBtn = document.querySelector('.remove-bg');
                if (removeBtn) {
                    removeBtn.classList.add('visible');
                }
                const colorOptions = document.querySelectorAll('.color-option');
                colorOptions.forEach(option => {
                    option.classList.remove('active');
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function removeBackground() {
    document.body.style.backgroundImage = '';
    document.body.classList.remove('with-background');
    document.querySelector('.container').classList.remove('with-background');
    const removeBtn = document.querySelector('.remove-bg');
    if (removeBtn) {
        removeBtn.classList.remove('visible');
    }
    const fileInput = document.getElementById('backgroundUpload');
    if (fileInput) {
        fileInput.value = '';
    }
    setThemeColor('#1a73e8');
}

function createRipple(event) {
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;
    const rect = button.getBoundingClientRect();
    ripple.style.width = ripple.style.height = `${diameter}px`;
    ripple.style.left = `${event.clientX - rect.left - radius}px`;
    ripple.style.top = `${event.clientY - rect.top - radius}px`;
    ripple.classList.add('ripple');
    const existingRipple = button.getElementsByClassName('ripple')[0];
    if (existingRipple) {
        existingRipple.remove();
    }
    button.appendChild(ripple);
}

function toggleSettings() {
    const popup = document.querySelector('.settings-popup');
    const overlay = document.querySelector('.settings-overlay');
    if (popup.classList.contains('open')) {
        popup.classList.remove('open');
        overlay.classList.remove('open');
        document.body.style.overflow = 'auto';
    } else {
        popup.classList.add('open');
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
}

function closeSettings() {
    const popup = document.querySelector('.settings-popup');
    const overlay = document.querySelector('.settings-overlay');
    popup.classList.remove('open');
    overlay.classList.remove('open');
    document.body.style.overflow = 'auto';
}

document.addEventListener('DOMContentLoaded', () => {
    const shipmentInput = document.getElementById('shipmentInput');
    if (shipmentInput) {
        // Existing event listeners
        shipmentInput.addEventListener('paste', e => {
            if (autoParse) {
                setTimeout(() => {
                    if (autoTracking) {
                        parseTrackingOnly();
                    } else {
                        parseShipmentData();
                        if (autoTemplate) {
                            setTimeout(() => {
                                toggleTemplateToAll();
                            }, 100);
                        }
                    }
                }, 100);
            }
        });
        shipmentInput.addEventListener('input', () => {
            const clearButton = document.querySelector('button[onclick="clearData()"]');
            clearButton.disabled = !shipmentInput.value.trim();
        });

        // MutationObserver to detect changes to the input field
        const observer = new MutationObserver(() => {
            if (autoParse) {
                setTimeout(() => {
                    if (autoTracking) {
                        parseTrackingOnly();
                    } else {
                        parseShipmentData();
                        if (autoTemplate) {
                            setTimeout(() => {
                                toggleTemplateToAll();
                            }, 100);
                        }
                    }
                }, 100);
            }
        });

        observer.observe(shipmentInput, { attributes: true, childList: true, subtree: true, characterData: true });
    }
});

// Other functions and event listeners
</script>
